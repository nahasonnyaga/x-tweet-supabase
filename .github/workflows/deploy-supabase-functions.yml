- name: Deploy processPost function
  env:
    SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  run: |
    set -e  # exit immediately if a command fails

    echo "Logging in to Supabase CLI..."
    supabase login --token $SUPABASE_ACCESS_TOKEN

    echo "Linking project..."
    supabase link --project-ref xadpyaiwqrrwzlqrlysz

    echo "Recreating Deno lockfile for processPost..."
    cd supabase/functions/processPost
    if [ -f "deno.lock" ]; then
      rm deno.lock
    fi
    deno cache --lock=deno.lock index.ts

    echo "Deploying processPost function..."
    supabase functions deploy processPost --project-ref xadpyaiwqrrwzlqrlysz

    echo "Testing deployed function..."
    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://xadpyaiwqrrwzlqrlysz.functions.supabase.co/processPost" \
      -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"name":"GitHub Actions"}')

    BODY=$(echo "$RESPONSE" | sed '$d')
    STATUS=$(echo "$RESPONSE" | tail -n1)

    echo "Function response body: $BODY"
    echo "Function response status: $STATUS"

    if [ "$STATUS" -ne 200 ]; then
      echo "Function test failed!"
      exit 1
    fi

    echo "Function test succeeded!"
